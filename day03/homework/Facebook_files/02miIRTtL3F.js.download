;/*FB_PKG_DELIM*/

__d("ZenonDGWLogger",["DGWStreamGroupCallbacks","QuickPerformanceLogger","ZenonAuditedCheckpointLogId","ZenonDebugLogger","ZenonInfraActionsLogger","ZenonLoggingUtils","ZenonODSLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("qpl")._(398986999,"3052"),j=c("ZenonDebugLogger").getInstance();function a(a,b){if(!d("ZenonLoggingUtils").shouldAllowLogging())return;switch(a.name){case"dgwStreamCreationInitiated":k(b,a.headers,a.dgwInfo);break;case"dgwStreamCreationSuccess":(h||(h=c("QuickPerformanceLogger"))).markerEnd(i,2,b);break;case"dgwStreamCreationError":j.logConsole("[DGW] Stream creation error: "+a.error);(h||(h=c("QuickPerformanceLogger"))).markerAnnotate(i,{string:{error:a.error}},{instanceKey:b});(h||(h=c("QuickPerformanceLogger"))).markerEnd(i,87,b);break;case"dgwStreamClosed":j.logConsole("[DGW] Stream closed"+(a.reason!=null?" - Reason: "+a.reason:"")+"}");break;case"dgwStreamError":j.logConsole("[DGW] Stream error: "+a.error);break;default:break}}function k(a,b,d){(h||(h=c("QuickPerformanceLogger"))).markerStart(i,a),h.markerAnnotate(i,{bool:{hasAuthToken:d.hasAuthToken},string:babelHelpers["extends"]({},b,{deviceId:d.deviceId,loggingId:d.loggingId,serviceId:d.serviceId,windowContext:d.windowContext})},{instanceKey:a}),h.markerPoint(i,"initStreamCreation",{instanceKey:a})}function b(a,b){b="DGW_STREAM_ERROR_"+b+"_"+a;r(b);c("ZenonODSLogger").logCounter(b)}function e(){r("DGW_SERVER_HAS_FINISHED_SENDING_DATA"),c("ZenonODSLogger").logCounter("DGW_SERVER_HAS_FINISHED_SENDING_DATA")}function f(a){a="DGW_STREAM_MUST_DRAIN_"+a;r(a);c("ZenonODSLogger").logCounter(a)}function l(){r("DGW_STREAM_RETRY"),c("ZenonODSLogger").logCounter("DGW_STREAM_RETRY")}function m(a){a=a?"_"+a:"";r("DGW_STREAM_RETRY_SUCCEEDED"+a);c("ZenonODSLogger").logCounter("DGW_STREAM_SUCCEEDED_RETRY"+a)}function n(a){a=a?"_"+a:"";r("DGW_STREAM_RETRY_FAILED"+a);c("ZenonODSLogger").logCounter("DGW_STREAM_RETRY_FAILED"+a)}function o(a,b){r("["+a+"] Stream closed - Reason: "+(b!=null?b:""))}function p(a){a="DGW_STREAM_GROUP_ERROR_"+d("DGWStreamGroupCallbacks").dgwStreamGroupErrorToString(a);r(a);c("ZenonODSLogger").logCounter(a)}function q(a){a="DGW_STREAM_GROUP_MUST_DRAIN_"+a;r(a);c("ZenonODSLogger").logCounter(a)}function r(a){c("ZenonInfraActionsLogger").logCheckpoint({auditId:c("ZenonAuditedCheckpointLogId").RP_ROOMS_INFRA_WWW__PLATFORM,checkpoint:"[ZP] [DGW] "+a})}g.logEvent=a;g.logDGWErrorToODS=b;g.logDGWServerHasFinishedToODS=e;g.logDGWStreamMustDrainToODS=f;g.logDGWRetryToODS=l;g.logDGWSucceededRetry=m;g.logDGWFailedRetry=n;g.logDGWStreamClose=o;g.logDGWStreamGroupError=p;g.logDGWStreamGroupMustDrain=q}),98);
__d("ZenonDGWMessageQueue",[],(function(a,b,c,d,e,f){"use strict";a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.enqueue=function(a){this.$1.has(a.messageId)||this.$1.set(a.messageId,a)};b.dequeue=function(a){this.$1.delete(a)};b.sendAllWith=async function(a){this.$2(),await Promise.allSettled(this.$1.values().map(async function(b){b.succeeded=await a.send(b.data,b.timeoutInMs)}))};b.$2=function(){var a=this,b=Array.from(this.$1.values()).filter(function(b){return!a.$3(b)}).map(function(a){return a.messageId});b.forEach(function(b){return a.$1.delete(b)})};b.$3=function(a){var b=Date.now(),c=a.expiryTime;b=c!=null&&b>c;return!b&&!a.succeeded};return a}();f.default=a}),66);
__d("ZenonDGWStreamGroupCoordinator",["DGWClient","DGWStreamGroupHandler","ZenonDGWLogger","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=c("justknobx")._("5209"),i=c("justknobx")._("5210");a=function(){function a(a){this.$2=a}var b=a.prototype;b.$3=function(){var a=this;return new(c("DGWStreamGroupHandler"))(function(b){a.killStreamGroup(),d("ZenonDGWLogger").logDGWStreamGroupError(b),a.$2()},function(b){a.killStreamGroup(),d("ZenonDGWLogger").logDGWStreamGroupMustDrain(b),a.$2()},function(){a.killStreamGroup(),a.$2()})};b.establishStream=function(a,b,d){if(this.$1==null){var e;e={authToken:d.authToken,authType:d.authType,connectTimeoutMs:i,deviceId:d.deviceId,disableFalcoLogging:d.disableFalcoLogging,keepAliveMs:h,loggingId:d.loggingId,serviceId:(e=d.serviceId)!=null?e:"rpsignaling",streamGroupAppHeaders:{"stream-group":"group1"}};d.overrideUrl!=null&&(e.overrideUrl=d.overrideUrl);this.$1=c("DGWClient")().createStreamGroup(this.$3(),e)}return this.$1.establishStream({disableFalcoLogging:d.disableFalcoLogging,groupedStreamHeaders:a,loggingId:d.loggingId},b)};b.killStreamGroup=function(){var a;(a=this.$1)==null||a.close();this.$1=null};return a}();g["default"]=a}),98);
__d("ZenonDGWStreamController",["DGWStream","EventEmitter","Random","ZenonDGWLogger","ZenonDGWMessageQueue","ZenonDGWStreamGroupCoordinator","ZenonDeviceId","justknobx","promiseDone","qex","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h=c("justknobx")._("1942"),i=c("justknobx")._("5207"),j=c("justknobx")._("5208"),k=(a=c("qex")._("3872"))!=null?a:!1,l=null;b=function(a){function b(){var b;b=a.call(this)||this;b.$ZenonDGWStreamController$p_6=d("Random").uint32();b.$ZenonDGWStreamController$p_7="UNKNOWN";b.$ZenonDGWStreamController$p_8="Disconnected";b.$ZenonDGWStreamController$p_9=h;b.$ZenonDGWStreamController$p_10=!1;b.$ZenonDGWStreamController$p_11=!1;b.$ZenonDGWStreamController$p_5={deviceId:d("ZenonDeviceId").getZenonLocalStorageDeviceIdWithFallback(),loggingId:c("uuidv4")(),serviceId:"rpsignaling"};b.$ZenonDGWStreamController$p_1=new(c("ZenonDGWStreamGroupCoordinator"))(function(){c("promiseDone")(b.$ZenonDGWStreamController$p_17())});k&&(b.$ZenonDGWStreamController$p_2=new(c("ZenonDGWMessageQueue"))());b.$ZenonDGWStreamController$p_4={};return b}babelHelpers.inheritsLoose(b,a);b.getControllerInstance=function(){l||(l=new b());return l};var e=b.prototype;e.setHeaders=function(a){this.$ZenonDGWStreamController$p_4=a};e.setStreamOptions=function(a){this.$ZenonDGWStreamController$p_5=a};e.setWindowContext=function(a){this.$ZenonDGWStreamController$p_7=a};e.getStream=function(){return this.$ZenonDGWStreamController$p_3};e.closeStream=function(a){if(this.$ZenonDGWStreamController$p_3==null)return;this.$ZenonDGWStreamController$p_3.close();this.$ZenonDGWStreamController$p_3=null;d("ZenonDGWLogger").logDGWStreamClose(this.$ZenonDGWStreamController$p_7,a)};e.$ZenonDGWStreamController$p_18=function(a){this.$ZenonDGWStreamController$p_8=a,this.emit("connectionStateEvent",a)};e.$ZenonDGWStreamController$p_19=function(){var a=this,b={onClose:function(b){a.$ZenonDGWStreamController$p_12==null||a.$ZenonDGWStreamController$p_12(b),a.$ZenonDGWStreamController$p_3=null},onDataReceived:function(b){a.$ZenonDGWStreamController$p_13==null||a.$ZenonDGWStreamController$p_13(b)},onError:function(b){a.$ZenonDGWStreamController$p_14==null||a.$ZenonDGWStreamController$p_14(b),d("ZenonDGWLogger").logDGWErrorToODS(b,a.$ZenonDGWStreamController$p_7),void a.$ZenonDGWStreamController$p_20(b)},onServerHasFinishedSendingData:function(b){a.$ZenonDGWStreamController$p_16==null||a.$ZenonDGWStreamController$p_16(b),d("ZenonDGWLogger").logDGWServerHasFinishedToODS(),void a.$ZenonDGWStreamController$p_20()},onStreamMustDrain:function(b,c){a.$ZenonDGWStreamController$p_15==null||a.$ZenonDGWStreamController$p_15(b,c),d("ZenonDGWLogger").logDGWStreamMustDrainToODS(c),void a.$ZenonDGWStreamController$p_20()}};return b};e.$ZenonDGWStreamController$p_20=async function(a){if(!c("justknobx")._("2380")||a!=null&&!d("DGWStream").isRetryableError(a)||this.$ZenonDGWStreamController$p_9<=0||this.$ZenonDGWStreamController$p_10){d("ZenonDGWLogger").logEvent({error:String(a!=null?a:"drain"),name:"dgwStreamCreationError"},this.$ZenonDGWStreamController$p_6);this.$ZenonDGWStreamController$p_18("Disconnected");this.$ZenonDGWStreamController$p_9<=0&&d("ZenonDGWLogger").logDGWFailedRetry(a);return Promise.resolve()}this.closeStream("retrying stream establishment");this.$ZenonDGWStreamController$p_9--;this.$ZenonDGWStreamController$p_10=!0;d("ZenonDGWLogger").logDGWRetryToODS();a=await this.establishAndGetStream();d("ZenonDGWLogger").logDGWSucceededRetry();return a};e.setOnCloseCallback=function(a){this.$ZenonDGWStreamController$p_12=a};e.setOnDataReceivedCallback=function(a){this.$ZenonDGWStreamController$p_13=a};e.setOnErrorCallback=function(a){this.$ZenonDGWStreamController$p_14=a};e.setOnStreamMustDrainCallback=function(a){this.$ZenonDGWStreamController$p_15=a};e.setOnServerHasFinishedSendingDataCallback=function(a){this.$ZenonDGWStreamController$p_16=a};e.getConnectionState=function(){return this.$ZenonDGWStreamController$p_8};e.send=async function(a,b,c){b={data:b,expiryTime:Date.now()+i,messageId:a,succeeded:!1,timeoutInMs:c!=null?c:j};(a=this.$ZenonDGWStreamController$p_2)==null||a.enqueue(b);c=(a=await ((c=this.$ZenonDGWStreamController$p_3)==null?void 0:c.send(b.data,b.timeoutInMs)))!=null?a:!1;if(!c)await this.$ZenonDGWStreamController$p_17();else{b.succeeded=!0;(a=this.$ZenonDGWStreamController$p_2)==null||a.dequeue(b.messageId)}return c};e.$ZenonDGWStreamController$p_17=async function(){if(this.$ZenonDGWStreamController$p_11)return;this.$ZenonDGWStreamController$p_11=!0;try{this.closeStream("reestablishing stream"),this.$ZenonDGWStreamController$p_1.killStreamGroup(),await this.establishAndGetStream()}finally{this.$ZenonDGWStreamController$p_11=!1}};e.establishAndGetStream=async function(){if(this.$ZenonDGWStreamController$p_3)return this.$ZenonDGWStreamController$p_3;try{var a;d("ZenonDGWLogger").logEvent({dgwInfo:{deviceId:this.$ZenonDGWStreamController$p_5.deviceId,hasAuthToken:this.$ZenonDGWStreamController$p_5.authToken!=null,loggingId:this.$ZenonDGWStreamController$p_5.loggingId,serviceId:this.$ZenonDGWStreamController$p_5.serviceId,windowContext:this.$ZenonDGWStreamController$p_7},headers:this.$ZenonDGWStreamController$p_4,name:"dgwStreamCreationInitiated"},this.$ZenonDGWStreamController$p_6);this.$ZenonDGWStreamController$p_18("Connecting");var b=await this.$ZenonDGWStreamController$p_1.establishStream(this.$ZenonDGWStreamController$p_4,this.$ZenonDGWStreamController$p_19(),this.$ZenonDGWStreamController$p_5);d("ZenonDGWLogger").logEvent({name:"dgwStreamCreationSuccess"},this.$ZenonDGWStreamController$p_6);this.$ZenonDGWStreamController$p_9=h;this.$ZenonDGWStreamController$p_10=!1;this.$ZenonDGWStreamController$p_18("Connected");await ((a=this.$ZenonDGWStreamController$p_2)==null?void 0:a.sendAllWith(b));this.$ZenonDGWStreamController$p_3=b;return b}catch(b){this.$ZenonDGWStreamController$p_10=!1;a=await this.$ZenonDGWStreamController$p_20(b);if(a)return a;throw b}};return b}(c("EventEmitter"));g.default=b}),98);
__d("ZenonDGWMWThriftMessageSender",["ZenonDGWStreamController","ZenonMWThriftMessageDebugLogger","ZenonMWThriftMessageLogger","ZenonMWThriftMessageMap","ZenonMWThriftMessageReliabilityLogger","ZenonMWThriftMessageSerializer","ZenonMWThriftMessageTranslator","ZenonValidateMWThriftMessage","err"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){this.$3=c("ZenonDGWStreamController").getControllerInstance()}var b=a.prototype;b.$4=async function(a){await this.$3.establishAndGetStream();d("ZenonMWThriftMessageReliabilityLogger").logSendingMessage(a);c("ZenonMWThriftMessageDebugLogger").logMWThriftMessage("SENDING","DGW Thrift",a);this.$2&&d("ZenonMWThriftMessageLogger").logSentMessage(a,this.$2);var b=d("ZenonMWThriftMessageSerializer").serializeMWThriftMessage(a,!0);b=await this.$3.send(a.messageHeader.transactionId,b);b&&this.$2?this.$2({mwThriftMessage:a,name:"mwThriftMessageSent"}):b||this.$5(a,"Failed to send data")};b.$5=function(a,b){b=b!=null?b:"DGW Thrift Message Send Error";d("ZenonMWThriftMessageReliabilityLogger").logSendMessageFailed(a,"[DGW Thrift] "+b);c("ZenonMWThriftMessageDebugLogger").logSendMultiwayThriftMessageFailure(b,d("ZenonMWThriftMessageMap").messageTypeToString(a.messageHeader.type))};b.sendMessage=function(a){a=d("ZenonMWThriftMessageTranslator").toMWThriftMessage(a);return!a||!c("ZenonValidateMWThriftMessage")(a)?Promise.reject(c("err")("Invalid MW Thrift message")):this.$4(a)};b.setMessageReceiver=function(a){this.$1=a};b.setLoggingEventHandler=function(a){this.$2=a};return a}();g.default=a}),98);