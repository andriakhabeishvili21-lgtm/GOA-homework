;/*FB_PKG_DELIM*/

__d("MAWAsyncEBIssueFetchAndIndexFTSQuery",["I64","MAWEBUnstoredDbMsgUtils","MAWJobDefinitions","MAWUserJidWrapper","MpsOverBridge","MpsTypes","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,e,f,g){f===void 0&&(f=function(){});var i=d("WAJids").threadIdForChatJid(a),j=b==null?Date.now()+6e4:Number(b);f();return d("MpsOverBridge").mps().loadMessages({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!1,shouldFetchTags:!1,shouldIgnoreLocalOnly:!0,strategy:"remote-only"},debug:{purpose:"MAWAsyncEBIssueFetchAndIndexFTSQuery_"+g},direction:"desc",from:[d("MpsTypes").toTimestamp(j),null],numMessages:(h||(h=d("I64"))).to_int32(e),threadId:d("MpsTypes").toThreadId(a)}).then(function(b){var e;if(b.success===!1)throw b.payload||c("err")(b.error);var f=b.value.messages.map(d("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage);e=b.value.cursorInfo.hasNext?(e=b.value.cursorInfo.endCursor)==null?void 0:e[0]:0;return{echoMessages:[],hasMoreAfter:b.value.cursorInfo.hasPrevious,hasMoreBefore:b.value.cursorInfo.hasNext,isPointQuery:!1,messages:d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(f,void 0,a,d("MAWUserJidWrapper").getMyUserJid()),nextMessageTimestampMsBefore:e==null?void 0:(h||(h=d("I64"))).of_float(e),protobufMessages:f,referenceTimestamp:j.toString(),requestId:void 0,restoreType:"protobuf",threadId:i}})}g.issueQueryAsPromise=a}),98);
__d("MAWMediaGalleryBufferAndRestore",[],(function(a,b,c,d,e,f){"use strict";var g=null,h=[],i=[],j=[],k=null,l=2e3,m=10;function a(a,b,c,d,e,f,n,o,p,q){q==null||q.addPoint("buffer_and_restore_protobuf_start");var r=function(){h=h.concat(b),i=i.concat(c!=null?c:[]),q!=null&&j.push(q),h.length>=m?(j.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"max_buffer_size"}})}),void p(a,h,i,d,e,f,n,o,j),h=[],i=[],j=[]):k=window.setTimeout(function(){var b=[].concat(h),c=[].concat(i),g=[].concat(j);g.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"timeout"}})});void p(a,b,c,d,e,f,n,o,g);h=[];i=[];j=[]},l)},s=function(){window.clearTimeout(k);var a=h.map(function(a){return a}),b=i.map(function(a){return a}),c=[].concat(j),l=g;l!=null&&(c.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"immediately"}})}),void p(l,a,b,d,e,f,n,o,c));h=[];i=[];j=[]};if(a!==g){s();g=a;r();return}h.length===0?r():(h=h.concat(b),i=i.concat(c!=null?c:[]),q!=null&&j.push(q),h.length>=m&&s())}f.bufferAndRestoreProtobuf=a}),66);
__d("MWMediaRestoreStatus",["I64","LSDatabaseSingleton","MAWChatJid"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j={mediaCount:0,messageCount:0,threadId:(h||(h=d("I64"))).zero};async function a(a,b,c){var e=await (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton;e=await e.runInTransaction(function(b){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(b,(h||(h=d("I64"))).of_string(a))},"readwrite",void 0,void 0,f.id+":35");j.threadId===e?(j.messageCount+=b,j.mediaCount+=c):(j.messageCount=b,j.mediaCount=c,j.threadId=e!=null?e:(h||(h=d("I64"))).zero)}function b(){return j}g.updateRestoreStatus=a;g.getRestoreStatus=b}),98);
__d("MAWMediaGalleryRestoreSync",["CurrentUser","EchoMessage","EchoMessageMediaFieldUtils","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","LSThreadMediaGalleryGroup","MAWChatJid","MAWFTSRestoreSync","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaGalleryBufferAndRestore","MAWMediaGalleryEBTaggingUtils","MAWRestoreMessagesFromEncryptedBackupsDeferred","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWMediaRestoreStatus","ReQL","WAJobOrchestratorTypes","WALogger","WAMsgType","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p;async function a(a,b){var e=a.echoMessages,g=a.hasMoreAfter,p=a.hasMoreBefore,r=a.isPointQuery,s=a.protobufMessages,t=a.referenceTimestamp,u=a.requestId,v=a.restoreType,w=a.threadId;if(w==null){b==null||b.endFail("threadId is null");d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: threadId is null"])));return}b==null||b.addAnnotations({string:{restore_type:v}});b==null||b.addPoint("handle_media_restore_sync_start");var x=!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled();if(v==="echo"){var y;if(e==null){b==null||b.endFail("echoMessages is null");d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: echoMessages is null"])));return}b==null||b.addPoint("messages_decoding_and_filtering_start");a=e.filter(function(a){var b;a=d("EchoMessage").decodeEchoMessage(a);return x?(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA:(a==null||(b=a.mediaData)==null?void 0:b.attachmentType)===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT});b==null||b.addPoint("messages_decoding_and_filtering_end");a.length>0&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);b==null||b.addAnnotations({int:{media_count:a.length,message_count:e.length}});b==null||b.addPoint("update_media_restore_status_start");await d("MWMediaRestoreStatus").updateRestoreStatus(w,e.length,a.length);b==null||b.addPoint("update_media_restore_status_end");b==null||b.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(y=e==null?void 0:e.length)!=null?y:0,protobuf_msg_count:a.length}});c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(w),a.map(d("MAWJobDefinitions").toEncodedEchoMessage),p,void 0,g,void 0,r,u,t,c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW).catch(function(a){b==null||b.endFail(a),d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Echo error: ",""])),a)}),function(){b==null||b.addPoint("restore_messages_in_worker_end"),b==null||b.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((n||(n=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(a){b==null||b.addPoint("update_range_get_thread_key_start");var e=await a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(o||(o=d("I64"))).of_string(w))},"readonly",void 0,void 0,f.id+":151");b==null||b.addPoint("update_range_get_thread_key_end");if(e==null){b==null||b.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return Promise.all([q(a,e,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),q(a,e,c("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),b==null||b.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),b==null||b.addPoint("handle_media_restore_sync_end"),b==null||b.endSuccess()}))})}else if(v==="protobuf"){if(s==null){b==null||b.endFail("protobufMessages is null");d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: protobufMessages is null"])));return}b==null||b.addPoint("get_user_jid_start");var z=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());b==null||b.addPoint("get_user_jid_end");b==null||b.addPoint("messages_decoding_and_filtering_start");y=s.filter(function(a){a=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(a,z,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);return x&&[d("WAMsgType").MSG_TYPE.IMAGE,d("WAMsgType").MSG_TYPE.VIDEO].includes(a.msgType)||a.msgType===d("WAMsgType").MSG_TYPE.DOCUMENT_FILE});b==null||b.addPoint("messages_decoding_and_filtering_end");y.length>0&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);b==null||b.addAnnotations({int:{media_count:y.length,message_count:s.length}});b==null||b.addPoint("update_media_restore_status_start");await d("MWMediaRestoreStatus").updateRestoreStatus(w,s.length,y.length);b==null||b.addPoint("update_media_restore_status_end");a=function(a,b,e,g,h,i,j,k,m){var p;if(((p=e==null?void 0:e.length)!=null?p:0)===0&&b.length===0){m.forEach(function(a){a.addPoint("restore_messages_in_worker_skipped"),a.endSuccess()});return}m.forEach(function(a){return a.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(a=e==null?void 0:e.length)!=null?a:0,protobuf_msg_count:b.length}})});c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),b,g,void 0,h,void 0,i,j,k,void 0,e,(o||(o=d("I64"))).of_int32(c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE),d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,void 0).catch(function(a){m.forEach(function(b){return b.endFail(a)}),d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""])),a)}),function(){m.forEach(function(a){return a.addPoint("restore_messages_in_worker_end")}),m.forEach(function(a){return a.addPoint("restore_messages_update_ranges_start")}),c("promiseDone")((n||(n=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(a){m.forEach(function(a){return a.addPoint("update_range_get_thread_key_start")});var b=await a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(o||(o=d("I64"))).of_string(w))},"readonly",void 0,void 0,f.id+":314");m.forEach(function(a){return a.addPoint("update_range_get_thread_key_end")});if(b==null){m.forEach(function(a){return a.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}})});return}return Promise.all([q(a,b,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),q(a,b,c("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),m.forEach(function(a){return a.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}})}),m.forEach(function(a){return a.addPoint("handle_media_restore_sync_end")}),m.forEach(function(a){return a.endSuccess()})}))})};d("MAWMediaGalleryBufferAndRestore").bufferAndRestoreProtobuf(w,y,e,p,g,r,u,t,a,b)}else b==null||b.endFail("RestoreType is none"),d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore RestoreType is none"])))}function q(a,b,c){return d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryGroupSupportedForTaggedRestore(c)?Promise.resolve():a.runInTransaction(async function(e){var f=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.attachments_ranges_v2__generated).getKeyRange(b).filter(function(a){return(o||(o=d("I64"))).equal(a.mediaGroup,(p||(p=d("LSIntEnum"))).ofNumber(c))}));if(f==null||(f==null?void 0:f.hasMoreBefore)===!0)return;var g=babelHelpers.extends({},f,{hasMoreBefore:!0});return e.attachments_ranges_v2__generated.upsert([f.threadKey,f.mediaGroup,f.minTimestampMs],g)},"readwrite","ui",void 0,f.id+":395")}g.handleMediaRestoreSync=a}),98);
__d("MWEncryptedBackUpEBNotEnabledError",[],(function(a,b,c,d,e,f){"use strict";a="EB not enabled";f.EB_NOT_ENABLED=a}),66);
__d("MWMediaRestoreQplUtils",["QPLFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=18e4;function a(){var a=c("qpl")._(25304794,"2287");return d("QPLFlow").startQPLFlow(a,{timeoutInMs:h})}function b(){var a=c("qpl")._(25306381,"2492");return d("QPLFlow").startQPLFlow(a,{timeoutInMs:h})}g.startMediaRestoreBatchQPLFlow=a;g.startMediaRestoreLoadAllQPLFlow=b}),98);
__d("isEbEnabledWithIGDEligibilityCheck",["EBIsEbEnabled","Promise","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return!c("gkx")("23914")?(h||(h=b("Promise"))).resolve(!1):d("EBIsEbEnabled").isEbEnabledLS(a.tables)}g.isEbEnabledWithIGDEligibilityCheck=a}),98);
__d("MAWFTSRestoreSync",["EventEmitter","FBLogger","I64","LSDatabaseSingleton","MAWAsyncEBIssueFetchAndIndexFTSQuery","MAWBridgeFireAndForget","MAWBridgeSearchMsg","MAWBridgeSendAndReceive","MAWDbMsg","MAWFTSIsMessageValidForSearch","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWMediaGalleryRestoreSync","MWEncryptedBackUpEBNotEnabledError","MWMediaRestoreQplUtils","QPLFlow","WAPromiseDelays","cr:19810","err","getErrorSafe","isEbEnabledWithIGDEligibilityCheck","justknobx","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=new(c("EventEmitter"))(),k=(h||(h=d("I64"))).of_int32(c("justknobx")._("2477")),l=c("justknobx")._("2606"),m=c("uuidv4")();function n(a){return new Promise(function(b,d){return globalThis.setTimeout(function(){return d(c("err")("timeout"))},a)})}function o(){window.setInterval(function(){d("MAWBridgeFireAndForget").fireAndForget("backend","searchFTSReportTabAlive",{hasFocus:document.hasFocus(),tabId:m},!0)},1e3)}async function p(a){await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabTaskComplete",{error:a,tabId:m})}async function q(){await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabDestroy",{tabId:m})}function r(a){var b=200,c=12e4;return Math.min(b*Math.pow(3,a),c)}var s=function(){function a(a){a===void 0&&(a="search"),this.$1=!1,this.$2=!0,this.$3=!1,this.$4=!0,this.$5=void 0,this.$6={},this.$7=new Set(),this.$8=new Set(),this.$9=new Set(),this.$10=a,c("FBLogger")("fts_worker").info("New MAWFTSRestoreSync instance: "+a)}var e=a.prototype;e.setIsStarted=function(a){this.$1=a,this.$10==="media"&&j.emit("isSyncStarted",a)};e.setIsEBMaybeAvailable=function(a){this.$4=a,this.$10==="media"&&j.emit("isEBMaybeAvailable",a)};e.setActiveThreadId=function(a,c){c===void 0&&(c=!0),b("cr:19810")!=null&&c&&(a!=null&&b("cr:19810").getInstance().insertIntoHead(a)),this.$5=a,this.$10==="media"&&j.emit("activeThreadJid",a)};e.setShouldPauseRestore=function(a){this.$3=a};e.removeFromQueue=function(a){b("cr:19810")!=null&&a!=null&&b("cr:19810").getInstance().removeThread(a)};e.getActiveThreadId=function(){return this.$5};e.getNextThreadIdToFetch=function(){if(b("cr:19810")!=null){var a;return(a=b("cr:19810").getInstance().getThreadsHead())!=null?a:this.getActiveThreadId()}return this.getActiveThreadId()};e.getDoneThreads=function(){return this.$7};e.getDoneThreadsAfterReset=function(){return this.$9};e.getResetThreads=function(){return this.$8};e.isStarted=function(){return this.$1};e.isEBMaybeAvailable=function(){return this.$4};e.resetEBAvailability=function(){this.setIsEBMaybeAvailable(!0)};e.resetRestoreStatus=function(){var a=this,b=this.getActiveThreadId();return b!=null&&!this.$8.has(b)?d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSClearThreadRestoreStatus",{threadId:b},{isLoggingDisabled:!0}).then(function(){a.$8.add(b)}):Promise.resolve()};e.$11=function(a,b){var c=this;Object.keys(this.$6).forEach(function(d){c.$6[d](a,b)})};e.$12=function(a,c,e){return a!==c&&b("cr:19810")!=null?e==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(e,10)):e!=="0"};e.$13=async function(){this.setIsStarted(!0),this.setShouldPauseRestore(!1),await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0}),window.addEventListener("focus",async function(){await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0})}),o()};e.shouldLoop=async function(a){if(this.$1||this.$4===!1)return!1;await this.$13();a=await d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(a);if(!a){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return!1}return!0};e.loadMessages=async function(a,b,e,f,g,i,j){var o=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:m,threadJid:a});if(!o){await d("WAPromiseDelays").delayMs(200);return"CONTINUE"}var r=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(a,b,k,e,i);if(r==null){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return"STOP"}var s=g();s.addAnnotations({int:{retryCount:f},string:{restoreUntilMs:b!=null?b:""}});try{o=function(){return Promise.race([r,n(l)])};var t=await d("QPLFlow").QplSubspan.wrapInSubspan(s,"fetch_request",o);a=t.nextMessageTimestampMsBefore!=null?(h||(h=d("I64"))).to_int32(t.nextMessageTimestampMsBefore):void 0;e=Number(b)===a;s.addAnnotations({bool:{paginationStuck:e},int:{numMessages:t.messages.length}});e&&a!=null&&c("justknobx")._("263")&&(t=babelHelpers.extends({},t,{nextMessageTimestampMsBefore:(h||(h=d("I64"))).of_int32(a-1)}));await d("QPLFlow").QplSubspan.wrapInSubspan(s,"process_data",function(){return j(t,s)});s.endSuccess();await p();return"CONTINUE"}catch(a){i=c("getErrorSafe")(a);if(i&&i.message===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){s.addPoint("eb_not_enabled");s.endCancel();this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);await q();return"STOP"}if(i.message==="invalid-client-state")return"FAIL";c("FBLogger")("fts_worker").catching(i).mustfix("Fail to fetch a new batch of messages");s.endFail((g=i.message)!=null?g:"unknown");await p(i);return"FAIL"}};e.startSyncingLoop=async function(){var a=this;this.setShouldPauseRestore(!1);var e=await (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton;if(!await this.shouldLoop(e))return;await d("MAWFTSRestoreSyncLogger").initLoggingSessionId();var f=0,g=null;e=async function(){var e,i=a.getNextThreadIdToFetch(),j=a.getActiveThreadId();g!==i&&(g=i,f=0);if(i==null||b("cr:19810")==null&&a.$7.has(i)){await d("WAPromiseDelays").delayMs(200);return 0}if(a.$3){await d("WAPromiseDelays").delayMs(200);return 0}var k=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:i},{isLoggingDisabled:!0}),l=(e=k==null?void 0:k.restoredUntilSortOrderMs)!=null?e:null,m=k==null||k.restoredUntilSortOrderMs===k.maxRestoredUntilSortOrderMs||k.restoredUntilSortOrderMs==null;e=a.$12(i,j,l);if(!e){l==="0"&&(a.$7.add(i),a.$8.has(i)&&a.$9.add(i));a.removeFromQueue(i);await d("WAPromiseDelays").delayMs(200);return 0}k=await a.loadMessages(i,l,function(){d("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(i,l==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(l,10)),m)},f,function(){return d("QPLFlow").startQPLFlow(c("qpl")._(25300854,"2397"))},"fts",async function(b){var c=b.messages;b=b.nextMessageTimestampMsBefore;b=b!=null?(h||(h=d("I64"))).to_string(b):"0";var e=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(b,10));d("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(i,c.length,e);a.$11(i,c);e=c.map(function(a){var b=d("MAWFTSIsMessageValidForSearch").verifyMessageValidity(a);return b==null?null:d("MAWBridgeSearchMsg").createBridgeSearchMsg(babelHelpers.extends({author:a.author,canonicalTs:d("MAWDbMsg").getCanonicalTsFromMsg(a),externalId:a.externalId,threadJid:i},b),!1)}).filter(Boolean);await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:b,threadId:i,unvaultedBridgeSearchMessages:e})});$$gen$m0:{if(k==="CONTINUE"){f=0;break $$gen$m0}if(k==="FAIL"){d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(i);await d("WAPromiseDelays").delayMs(r(f));f++;break $$gen$m0}if(k==="STOP"){return{v:void 0};break $$gen$m0}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+k)}};var j;while(this.$2){j=await e();if(j===0)continue;if(j)return j.v}};e.startMediaSyncingLoop=async function(){var a=this,b=await (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton;if(!await this.shouldLoop(b))return;var c=0;b=async function(){var b=a.getActiveThreadId();if(b==null||a.$7.has(b)){await d("WAPromiseDelays").delayMs(200);return 0}if(a.$3){await d("WAPromiseDelays").delayMs(200);return 0}var e=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","getThreadMediaRestoreStatus",{threadId:b},{isLoggingDisabled:!0});e=(e=e==null?void 0:e.restoredUntilSortOrderMs)!=null?e:null;j.emit("restoredUntilMs",e!=null?parseInt(e,10):-1);var f=a.$12(b,b,e);if(!f){e==="0"&&a.$7.add(b);await d("WAPromiseDelays").delayMs(200);return 0}f=await a.loadMessages(b,e,void 0,c,d("MWMediaRestoreQplUtils").startMediaRestoreBatchQPLFlow,"media",async function(a,c){var e=a.nextMessageTimestampMsBefore!=null?(h||(h=d("I64"))).to_string(a.nextMessageTimestampMsBefore):"0";await d("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(a,c);await d("MAWBridgeSendAndReceive").sendAndReceive("backend","setThreadMediaRestoreStatus",{newSortOrderMs:e,threadId:b},{isLoggingDisabled:!0})});$$gen$m1:{if(f==="CONTINUE"){c=0;break $$gen$m1}if(f==="FAIL"){await d("WAPromiseDelays").delayMs(r(c));c++;break $$gen$m1}if(f==="STOP"){return{v:void 0};break $$gen$m1}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+f)}};var e;while(this.$2){e=await b();if(e===0)continue;if(e)return e.v}};a.getInstance=function(){var b=a.instance;if(b!=null)return b;b=new a();a.instance=b;return b};a.getMediaInstance=function(){var b=a.mediaInstance;if(b!=null)return b;b=new a("media");a.mediaInstance=b;return b};a.resetInstance=function(){a.instance=null};e.setKeepWhileLoop_FOR_TESTING_ONLY=function(a){this.$2=a};return a}();s.instance=null;s.mediaInstance=null;function a(){return s.getInstance()}function e(){return s.getMediaInstance()}g.MAWGalleryEventEmitter=j;g.MAWFTSRestoreSync=s;g.getFTSRestoreSync=a;g.getMediaRestoreSync=e}),98);
__d("MWV2MediaViewerDebugMenu.react",["fbt","MWChatMessageBothOrientationFocusGroup.react","MWDebugMessageMenuItem.react","MWXMenu.react","MWXPopover.react","focusScopeQueries","react","react-compiler-runtime"],(function(a,b,c,d,e,f,g,h){"use strict";var i,j=i||d("react"),k=h._(/*BTDS*/"\u10ee\u10d0\u10e0\u10d5\u10d4\u10d6\u10d4\u10d1\u10d8\u10e1 \u10d2\u10d0\u10db\u10dd\u10e1\u10d0\u10e1\u10ec\u10dd\u10e0\u10d4\u10d1\u10d4\u10da\u10d8 \u10d6\u10dd\u10db\u10d4\u10d1\u10d8");function a(a){var b=d("react-compiler-runtime").c(3),e=a.attachment;a=a.message;var f;b[0]!==e||b[1]!==a?(f=j.jsx(c("MWXPopover.react"),{role:"menu",withArrow:!0,children:j.jsx(d("MWChatMessageBothOrientationFocusGroup.react").keyCommands,{children:j.jsx(d("MWChatMessageBothOrientationFocusGroup.react").FocusGroup,{allowModifiers:!0,orientation:"both",preventScrollOnFocus:!1,tabScopeQuery:d("focusScopeQueries").tabbableScopeQuery,children:j.jsx(c("MWXMenu.react"),{"aria-label":k,size:"full",truncate:!0,children:j.jsx(c("MWDebugMessageMenuItem.react"),{attachment:e,message:a})})})})}),b[0]=e,b[1]=a,b[2]=f):f=b[2];return f}g["default"]=a}),226);